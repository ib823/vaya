<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VAYA â€” Oracle ML Specification v1.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700;800&family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --mint: #00F5A0; --mint-dim: rgba(0,245,160,0.12);
            --cyan: #00D9FF; --cyan-dim: rgba(0,217,255,0.12);
            --white: #FFFFFF;
            --n0: #000000; --n50: #0A0A0B; --n100: #111113; --n200: #1A1A1D; --n300: #232326;
            --n600: #5C5C63; --n700: #7A7A82; --n800: #9999A1;
            --error: #FF4757; --warning: #FFB800; --purple: #A855F7; --blue: #3B82F6;
            --font-display: 'Space Grotesk', sans-serif;
            --font-body: 'DM Sans', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font-body); background: var(--n0); color: var(--white); line-height: 1.6; font-size: 14px; }
        .container { max-width: 1400px; margin: 0 auto; padding: 40px; }
        .header { text-align: center; padding: 60px 0; border-bottom: 3px solid var(--purple); margin-bottom: 48px; background: linear-gradient(180deg, rgba(168,85,247,0.1) 0%, transparent 100%); }
        .logo { font-family: var(--font-display); font-size: 56px; font-weight: 800; }
        .logo span:first-child { color: var(--mint); }
        .logo span:last-child { color: var(--cyan); }
        .title { font-family: var(--font-display); font-size: 28px; font-weight: 700; color: var(--purple); margin-top: 16px; }
        .section { margin-bottom: 48px; }
        .section-header { display: flex; align-items: center; gap: 12px; padding: 16px 20px; background: var(--n100); border-left: 4px solid var(--purple); margin-bottom: 20px; }
        .section-id { font-family: var(--font-mono); font-size: 11px; background: var(--n200); padding: 4px 8px; border-radius: 4px; color: var(--n600); }
        .section-title { font-family: var(--font-display); font-size: 20px; font-weight: 700; }
        .subsection { background: var(--n50); border: 1px solid var(--n200); border-radius: 12px; padding: 24px; margin-bottom: 16px; }
        .subsection h4 { font-family: var(--font-display); font-size: 14px; font-weight: 700; color: var(--cyan); margin-bottom: 12px; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; margin: 12px 0; }
        th { background: var(--n100); padding: 10px 12px; text-align: left; font-size: 10px; text-transform: uppercase; color: var(--n600); }
        td { padding: 10px 12px; border-bottom: 1px solid var(--n200); vertical-align: top; }
        .code { font-family: var(--font-mono); font-size: 11px; background: var(--n200); padding: 2px 6px; border-radius: 4px; }
        .code-block { background: var(--n100); border-radius: 8px; padding: 16px; font-family: var(--font-mono); font-size: 11px; overflow-x: auto; margin: 12px 0; white-space: pre; line-height: 1.5; }
        .feature-card { background: var(--n100); border-radius: 8px; padding: 12px 16px; margin: 8px 0; }
        .feature-name { font-family: var(--font-mono); color: var(--mint); font-size: 12px; }
        .feature-desc { font-size: 11px; color: var(--n700); margin-top: 4px; }
        .metric-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin: 16px 0; }
        .metric-box { background: var(--n100); border-radius: 8px; padding: 16px; text-align: center; }
        .metric-value { font-family: var(--font-display); font-size: 24px; font-weight: 800; }
        .metric-label { font-size: 10px; color: var(--n600); margin-top: 4px; }
        .pipeline-step { display: flex; align-items: center; gap: 16px; padding: 16px; background: var(--n100); border-radius: 8px; margin: 8px 0; }
        .step-num { width: 40px; height: 40px; background: var(--purple); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-family: var(--font-display); font-weight: 800; }
        .step-content { flex: 1; }
        .step-title { font-weight: 600; font-size: 13px; }
        .step-desc { font-size: 11px; color: var(--n700); margin-top: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo"><span>VA</span><span>YA</span></div>
            <h1 class="title">ðŸ”® Oracle ML Specification</h1>
            <p style="color: var(--n600); margin-top: 12px;">Price Prediction Engine Architecture</p>
        </header>

        <!-- ================================================================ -->
        <!-- ML-01: FEATURE ENGINEERING -->
        <!-- ================================================================ -->
        <section class="section">
            <div class="section-header">
                <span class="section-id">ML-01</span>
                <span class="section-title">Feature Engineering (47 Features)</span>
            </div>

            <div class="subsection">
                <h4>ðŸ“… Temporal Features (12)</h4>
                <table>
                    <tr><th>Feature</th><th>Type</th><th>Description</th><th>Computation</th></tr>
                    <tr><td class="code">days_until_departure</td><td>int</td><td>Days from search to departure</td><td>departure_date - current_date</td></tr>
                    <tr><td class="code">days_until_return</td><td>int</td><td>Days from search to return</td><td>return_date - current_date (null if one-way)</td></tr>
                    <tr><td class="code">trip_duration_days</td><td>int</td><td>Length of trip</td><td>return_date - departure_date</td></tr>
                    <tr><td class="code">departure_dow</td><td>int</td><td>Day of week (0=Sun)</td><td>departure_date.weekday()</td></tr>
                    <tr><td class="code">return_dow</td><td>int</td><td>Return day of week</td><td>return_date.weekday()</td></tr>
                    <tr><td class="code">departure_month</td><td>int</td><td>Month (1-12)</td><td>departure_date.month</td></tr>
                    <tr><td class="code">departure_week</td><td>int</td><td>Week of year (1-52)</td><td>departure_date.isocalendar().week</td></tr>
                    <tr><td class="code">is_weekend_departure</td><td>bool</td><td>Departs Fri/Sat/Sun</td><td>departure_dow in [5, 6, 0]</td></tr>
                    <tr><td class="code">is_weekend_return</td><td>bool</td><td>Returns Fri/Sat/Sun</td><td>return_dow in [5, 6, 0]</td></tr>
                    <tr><td class="code">search_hour</td><td>int</td><td>Hour of search (0-23)</td><td>current_time.hour</td></tr>
                    <tr><td class="code">search_dow</td><td>int</td><td>Search day of week</td><td>current_date.weekday()</td></tr>
                    <tr><td class="code">hours_since_midnight</td><td>float</td><td>Decimal hours into day</td><td>hour + minute/60</td></tr>
                </table>
            </div>

            <div class="subsection">
                <h4>âœˆï¸ Route Features (10)</h4>
                <table>
                    <tr><th>Feature</th><th>Type</th><th>Description</th><th>Source</th></tr>
                    <tr><td class="code">route_distance_km</td><td>float</td><td>Great circle distance</td><td>Haversine formula</td></tr>
                    <tr><td class="code">route_popularity</td><td>float</td><td>Search volume percentile (0-1)</td><td>30-day search count / max</td></tr>
                    <tr><td class="code">route_competition</td><td>int</td><td>Number of airlines on route</td><td>routes.airlines.length</td></tr>
                    <tr><td class="code">is_domestic</td><td>bool</td><td>Same country origin/dest</td><td>origin.country == dest.country</td></tr>
                    <tr><td class="code">is_regional</td><td>bool</td><td>ASEAN to ASEAN</td><td>Both in ASEAN list</td></tr>
                    <tr><td class="code">is_hub_origin</td><td>bool</td><td>Origin is major hub</td><td>airports.is_major_hub</td></tr>
                    <tr><td class="code">is_hub_destination</td><td>bool</td><td>Destination is major hub</td><td>airports.is_major_hub</td></tr>
                    <tr><td class="code">timezone_diff_hours</td><td>float</td><td>Time zone difference</td><td>dest.tz - origin.tz</td></tr>
                    <tr><td class="code">typical_flight_duration</td><td>int</td><td>Avg flight time (minutes)</td><td>routes.avg_flight_duration_minutes</td></tr>
                    <tr><td class="code">route_booking_rate</td><td>float</td><td>Search-to-booking ratio</td><td>bookings_30d / searches_30d</td></tr>
                </table>
            </div>

            <div class="subsection">
                <h4>ðŸ’° Price History Features (12)</h4>
                <table>
                    <tr><th>Feature</th><th>Type</th><th>Description</th><th>Window</th></tr>
                    <tr><td class="code">price_current</td><td>int</td><td>Current lowest price (sen)</td><td>Now</td></tr>
                    <tr><td class="code">price_avg_7d</td><td>float</td><td>Average price last 7 days</td><td>7 days</td></tr>
                    <tr><td class="code">price_avg_30d</td><td>float</td><td>Average price last 30 days</td><td>30 days</td></tr>
                    <tr><td class="code">price_min_30d</td><td>int</td><td>Minimum price last 30 days</td><td>30 days</td></tr>
                    <tr><td class="code">price_max_30d</td><td>int</td><td>Maximum price last 30 days</td><td>30 days</td></tr>
                    <tr><td class="code">price_std_30d</td><td>float</td><td>Price standard deviation</td><td>30 days</td></tr>
                    <tr><td class="code">price_percentile</td><td>float</td><td>Current price percentile (0-1)</td><td>Historical</td></tr>
                    <tr><td class="code">price_change_1d</td><td>float</td><td>1-day price change %</td><td>1 day</td></tr>
                    <tr><td class="code">price_change_7d</td><td>float</td><td>7-day price change %</td><td>7 days</td></tr>
                    <tr><td class="code">price_trend_slope</td><td>float</td><td>Linear regression slope</td><td>7 days</td></tr>
                    <tr><td class="code">price_volatility</td><td>float</td><td>Coefficient of variation</td><td>30 days</td></tr>
                    <tr><td class="code">days_since_price_drop</td><td>int</td><td>Days since last >5% drop</td><td>30 days</td></tr>
                </table>
            </div>

            <div class="subsection">
                <h4>ðŸ“Š Seasonality Features (8)</h4>
                <table>
                    <tr><th>Feature</th><th>Type</th><th>Description</th><th>Source</th></tr>
                    <tr><td class="code">is_peak_season</td><td>bool</td><td>Peak travel season</td><td>Dec, Jun-Jul, school holidays</td></tr>
                    <tr><td class="code">is_holiday_departure</td><td>bool</td><td>Public holiday at departure</td><td>MY/destination holidays</td></tr>
                    <tr><td class="code">is_holiday_return</td><td>bool</td><td>Public holiday at return</td><td>MY/destination holidays</td></tr>
                    <tr><td class="code">is_school_holiday</td><td>bool</td><td>Malaysian school holiday</td><td>School calendar</td></tr>
                    <tr><td class="code">days_to_nearest_holiday</td><td>int</td><td>Days to nearest holiday</td><td>Holiday calendar</td></tr>
                    <tr><td class="code">is_event_period</td><td>bool</td><td>Major event at destination</td><td>Event database</td></tr>
                    <tr><td class="code">seasonal_demand_index</td><td>float</td><td>Historical demand for this week</td><td>YoY booking patterns</td></tr>
                    <tr><td class="code">seasonal_price_index</td><td>float</td><td>Historical price for this week</td><td>YoY price patterns</td></tr>
                </table>
            </div>

            <div class="subsection">
                <h4>ðŸŽ¯ Demand Features (5)</h4>
                <table>
                    <tr><th>Feature</th><th>Type</th><th>Description</th><th>Computation</th></tr>
                    <tr><td class="code">search_volume_24h</td><td>int</td><td>Searches for this route/date</td><td>Last 24h count</td></tr>
                    <tr><td class="code">search_volume_ratio</td><td>float</td><td>vs average search volume</td><td>24h / avg_24h</td></tr>
                    <tr><td class="code">alert_count</td><td>int</td><td>Active alerts for route</td><td>alerts.count</td></tr>
                    <tr><td class="code">pool_activity</td><td>int</td><td>Active pools for route</td><td>pools.count</td></tr>
                    <tr><td class="code">competitor_price_index</td><td>float</td><td>vs OTA prices</td><td>our_price / avg_ota_price</td></tr>
                </table>
            </div>

            <div class="code-block"># Feature Vector Example (JSON)
{
  "temporal": {
    "days_until_departure": 45,
    "departure_dow": 5,
    "is_weekend_departure": true,
    "search_hour": 22
  },
  "route": {
    "route_distance_km": 5327.4,
    "route_popularity": 0.85,
    "route_competition": 4,
    "is_domestic": false
  },
  "price_history": {
    "price_current": 123400,
    "price_avg_30d": 145600,
    "price_percentile": 0.23,
    "price_trend_slope": -0.015
  },
  "seasonality": {
    "is_peak_season": false,
    "seasonal_demand_index": 0.72
  },
  "demand": {
    "search_volume_ratio": 1.3,
    "alert_count": 247
  }
}</div>
        </section>

        <!-- ================================================================ -->
        <!-- ML-02: MODEL ARCHITECTURE -->
        <!-- ================================================================ -->
        <section class="section">
            <div class="section-header">
                <span class="section-id">ML-02</span>
                <span class="section-title">Model Architecture</span>
            </div>

            <div class="subsection">
                <h4>ðŸ—ï¸ Ensemble Architecture</h4>
                <p style="font-size: 12px; color: var(--n700); margin-bottom: 16px;">
                    Oracle uses an ensemble of three models with weighted voting for final prediction.
                </p>
                
                <table>
                    <tr><th>Model</th><th>Type</th><th>Strengths</th><th>Weight</th></tr>
                    <tr>
                        <td><span class="code">XGBoost</span></td>
                        <td>Gradient Boosting</td>
                        <td>Feature interactions, tabular data, fast inference</td>
                        <td>0.45</td>
                    </tr>
                    <tr>
                        <td><span class="code">LSTM</span></td>
                        <td>Recurrent Neural Network</td>
                        <td>Temporal patterns, sequence modeling</td>
                        <td>0.35</td>
                    </tr>
                    <tr>
                        <td><span class="code">Prophet</span></td>
                        <td>Time Series</td>
                        <td>Seasonality, holidays, trend decomposition</td>
                        <td>0.20</td>
                    </tr>
                </table>
            </div>

            <div class="subsection">
                <h4>ðŸ“Š XGBoost Configuration</h4>
                <div class="code-block"># XGBoost Hyperparameters (Rust xgboost crate)
XGBoostConfig {
    objective: "multi:softprob",  // Classification: buy_now, wait, watch
    num_class: 3,
    n_estimators: 500,
    max_depth: 8,
    learning_rate: 0.05,
    min_child_weight: 3,
    subsample: 0.8,
    colsample_bytree: 0.8,
    gamma: 0.1,
    reg_alpha: 0.1,      // L1 regularization
    reg_lambda: 1.0,     // L2 regularization
    scale_pos_weight: 1, // Balanced classes
    tree_method: "hist", // Fast histogram-based
    eval_metric: ["mlogloss", "merror"],
    early_stopping_rounds: 50,
    seed: 42
}</div>
            </div>

            <div class="subsection">
                <h4>ðŸ§  LSTM Architecture</h4>
                <div class="code-block"># LSTM Model (Rust burn/candle framework)
LSTMModel {
    # Input: 30-day price sequence + features
    input_dim: 47,
    sequence_length: 30,
    
    # Architecture
    layers: [
        Embedding(input_dim=47, output_dim=64),
        LSTM(input_size=64, hidden_size=128, num_layers=2, dropout=0.3, bidirectional=true),
        Attention(hidden_size=256),  # 128*2 for bidirectional
        Dense(256, 64, activation="relu"),
        Dropout(0.3),
        Dense(64, 3, activation="softmax")  # 3 classes
    ],
    
    # Training
    optimizer: "AdamW",
    learning_rate: 0.001,
    weight_decay: 0.01,
    batch_size: 256,
    epochs: 100,
    patience: 10  # Early stopping
}</div>
            </div>

            <div class="subsection">
                <h4>ðŸ“ˆ Prophet Configuration</h4>
                <div class="code-block"># Facebook Prophet for seasonality
ProphetConfig {
    growth: "linear",
    seasonality_mode: "multiplicative",
    
    # Custom seasonalities
    yearly_seasonality: true,
    weekly_seasonality: true,
    daily_seasonality: false,
    
    # Malaysian holidays
    holidays: [
        "hari_raya_aidilfitri",
        "chinese_new_year",
        "deepavali",
        "christmas",
        "school_holidays"
    ],
    
    # Changepoint detection
    changepoint_prior_scale: 0.05,
    changepoint_range: 0.8,
    
    # Uncertainty
    interval_width: 0.80,
    uncertainty_samples: 1000
}</div>
            </div>

            <div class="subsection">
                <h4>ðŸŽ¯ Ensemble Voting</h4>
                <div class="code-block"># Weighted Soft Voting
def ensemble_predict(features, price_history):
    # Get probabilities from each model
    xgb_probs = xgboost_model.predict_proba(features)      # [p_buy, p_wait, p_watch]
    lstm_probs = lstm_model.predict(features, price_history)
    prophet_signal = prophet_model.predict(price_history)  # Convert to probs
    
    # Weighted average
    weights = [0.45, 0.35, 0.20]
    ensemble_probs = (
        weights[0] * xgb_probs +
        weights[1] * lstm_probs +
        weights[2] * prophet_signal
    )
    
    # Final prediction
    prediction = argmax(ensemble_probs)  # 0=buy_now, 1=wait, 2=watch
    confidence = max(ensemble_probs)
    
    # Calibration (Platt scaling)
    calibrated_confidence = calibrator.transform(confidence)
    
    return {
        "recommendation": ["buy_now", "wait", "watch"][prediction],
        "confidence": calibrated_confidence,
        "probabilities": ensemble_probs
    }</div>
            </div>
        </section>

        <!-- ================================================================ -->
        <!-- ML-03: TRAINING DATA REQUIREMENTS -->
        <!-- ================================================================ -->
        <section class="section">
            <div class="section-header">
                <span class="section-id">ML-03</span>
                <span class="section-title">Training Data Requirements</span>
            </div>

            <div class="subsection">
                <h4>ðŸ“Š Data Volume Requirements</h4>
                <div class="metric-grid">
                    <div class="metric-box">
                        <div class="metric-value" style="color: var(--mint);">50M+</div>
                        <div class="metric-label">Price Observations</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-value" style="color: var(--cyan);">500+</div>
                        <div class="metric-label">Routes Covered</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-value" style="color: var(--purple);">2 Years</div>
                        <div class="metric-label">Historical Depth</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-value" style="color: var(--warning);">4x Daily</div>
                        <div class="metric-label">Observation Frequency</div>
                    </div>
                </div>

                <table>
                    <tr><th>Data Type</th><th>Minimum Volume</th><th>Frequency</th><th>Source</th></tr>
                    <tr><td>Price observations</td><td>50M rows</td><td>Every 6 hours</td><td>Affiliate APIs, GDS</td></tr>
                    <tr><td>Booking outcomes</td><td>100K bookings</td><td>Continuous</td><td>Internal bookings</td></tr>
                    <tr><td>Search sessions</td><td>1M sessions</td><td>Continuous</td><td>Internal searches</td></tr>
                    <tr><td>Holiday calendar</td><td>3 years</td><td>Annual update</td><td>Government sources</td></tr>
                    <tr><td>Event data</td><td>10K events</td><td>Weekly</td><td>Event APIs</td></tr>
                </table>
            </div>

            <div class="subsection">
                <h4>âœ… Data Quality Thresholds</h4>
                <table>
                    <tr><th>Metric</th><th>Threshold</th><th>Action if Failed</th></tr>
                    <tr><td>Missing values per feature</td><td>&lt; 5%</td><td>Imputation or feature exclusion</td></tr>
                    <tr><td>Price outliers (Â±3Ïƒ)</td><td>&lt; 1%</td><td>Flag and review</td></tr>
                    <tr><td>Duplicate observations</td><td>&lt; 0.1%</td><td>Deduplicate</td></tr>
                    <tr><td>Data freshness</td><td>&lt; 24 hours old</td><td>Alert + fallback</td></tr>
                    <tr><td>Route coverage</td><td>&gt; 95% of searches</td><td>Expand collection</td></tr>
                    <tr><td>Label accuracy</td><td>&gt; 99%</td><td>Re-label validation set</td></tr>
                </table>
            </div>

            <div class="subsection">
                <h4>ðŸ·ï¸ Labeling Strategy</h4>
                <div class="code-block"># Ground Truth Label Generation
def generate_label(observation, future_prices):
    """
    Label based on actual price trajectory after observation.
    
    buy_now (0): Price increased or stayed within 5% in next 14 days
    wait (1): Price dropped >10% in next 14 days
    watch (2): Price dropped 5-10% or was volatile
    """
    current_price = observation.price
    min_future_price = min(future_prices[:14])  # Next 14 days
    
    price_change = (min_future_price - current_price) / current_price
    
    if price_change >= -0.05:  # Didn't drop more than 5%
        return 0  # buy_now
    elif price_change <= -0.10:  # Dropped more than 10%
        return 1  # wait
    else:
        return 2  # watch

# Backfill labels for historical data
for observation in historical_observations:
    future_prices = get_prices(
        observation.route,
        observation.departure_date,
        from_time=observation.observed_at,
        to_time=observation.observed_at + 14_days
    )
    observation.label = generate_label(observation, future_prices)</div>
            </div>
        </section>

        <!-- ================================================================ -->
        <!-- ML-04: TRAINING PIPELINE -->
        <!-- ================================================================ -->
        <section class="section">
            <div class="section-header">
                <span class="section-id">ML-04</span>
                <span class="section-title">Training Pipeline Design</span>
            </div>

            <div class="subsection">
                <h4>ðŸ”„ Training Workflow</h4>
                
                <div class="pipeline-step">
                    <div class="step-num">1</div>
                    <div class="step-content">
                        <div class="step-title">Data Extraction</div>
                        <div class="step-desc">Extract price observations from VayaDB (oracle.price_observations). Filter by date range, remove outliers, handle missing values.</div>
                    </div>
                </div>
                
                <div class="pipeline-step">
                    <div class="step-num">2</div>
                    <div class="step-content">
                        <div class="step-title">Feature Engineering</div>
                        <div class="step-desc">Compute all 47 features per observation. Cache in feature store for fast retrieval. Normalize numerical features (StandardScaler).</div>
                    </div>
                </div>
                
                <div class="pipeline-step">
                    <div class="step-num">3</div>
                    <div class="step-content">
                        <div class="step-title">Label Generation</div>
                        <div class="step-desc">Backfill ground truth labels using future price data. Validate label distribution (should be ~40% buy, ~35% wait, ~25% watch).</div>
                    </div>
                </div>
                
                <div class="pipeline-step">
                    <div class="step-num">4</div>
                    <div class="step-content">
                        <div class="step-title">Train/Val/Test Split</div>
                        <div class="step-desc">Time-based split: Train (>60 days ago), Validation (30-60 days), Test (last 30 days). Never leak future data.</div>
                    </div>
                </div>
                
                <div class="pipeline-step">
                    <div class="step-num">5</div>
                    <div class="step-content">
                        <div class="step-title">Model Training</div>
                        <div class="step-desc">Train XGBoost, LSTM, Prophet in parallel. Hyperparameter tuning via Bayesian optimization (Optuna).</div>
                    </div>
                </div>
                
                <div class="pipeline-step">
                    <div class="step-num">6</div>
                    <div class="step-content">
                        <div class="step-title">Ensemble Calibration</div>
                        <div class="step-desc">Fit ensemble weights on validation set. Apply Platt scaling for confidence calibration.</div>
                    </div>
                </div>
                
                <div class="pipeline-step">
                    <div class="step-num">7</div>
                    <div class="step-content">
                        <div class="step-title">Evaluation</div>
                        <div class="step-desc">Evaluate on test set. Check accuracy, precision/recall per class, calibration error, and financial metrics (avg savings).</div>
                    </div>
                </div>
                
                <div class="pipeline-step">
                    <div class="step-num">8</div>
                    <div class="step-content">
                        <div class="step-title">Model Registry</div>
                        <div class="step-desc">Version model artifacts, store metrics, promote to staging if metrics pass thresholds.</div>
                    </div>
                </div>
            </div>

            <div class="subsection">
                <h4>â° Training Schedule</h4>
                <table>
                    <tr><th>Component</th><th>Frequency</th><th>Duration</th><th>Trigger</th></tr>
                    <tr><td>Full retraining</td><td>Weekly (Sunday 2am MYT)</td><td>~4 hours</td><td>Scheduled</td></tr>
                    <tr><td>Incremental update</td><td>Daily (4am MYT)</td><td>~30 min</td><td>Scheduled</td></tr>
                    <tr><td>Feature store refresh</td><td>Every 6 hours</td><td>~15 min</td><td>Scheduled</td></tr>
                    <tr><td>Emergency retrain</td><td>On demand</td><td>~4 hours</td><td>Accuracy < 70%</td></tr>
                </table>
            </div>
        </section>

        <!-- ================================================================ -->
        <!-- ML-05: INFERENCE PIPELINE -->
        <!-- ================================================================ -->
        <section class="section">
            <div class="section-header">
                <span class="section-id">ML-05</span>
                <span class="section-title">Inference Pipeline Design</span>
            </div>

            <div class="subsection">
                <h4>âš¡ Latency Requirements</h4>
                <div class="metric-grid">
                    <div class="metric-box">
                        <div class="metric-value" style="color: var(--mint);">&lt;50ms</div>
                        <div class="metric-label">p50 Latency</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-value" style="color: var(--cyan);">&lt;100ms</div>
                        <div class="metric-label">p95 Latency</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-value" style="color: var(--purple);">&lt;200ms</div>
                        <div class="metric-label">p99 Latency</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-value" style="color: var(--warning);">10K/sec</div>
                        <div class="metric-label">Throughput</div>
                    </div>
                </div>
            </div>

            <div class="subsection">
                <h4>ðŸ­ Inference Architecture</h4>
                <div class="code-block"># Rust Inference Service (VayaOracle)
struct OracleService {
    xgboost_model: XGBoostPredictor,  // ONNX runtime
    lstm_model: LSTMPredictor,         // Burn framework
    prophet_cache: ProphetCache,       // Pre-computed forecasts
    feature_store: FeatureStoreClient, // VayaCache
    calibrator: PlattCalibrator,
}

impl OracleService {
    async fn predict(&self, request: PredictionRequest) -> PredictionResponse {
        // 1. Fetch features (parallel)
        let features = tokio::join!(
            self.feature_store.get_route_features(&request.route),
            self.feature_store.get_price_history(&request.route, 30),
            self.compute_temporal_features(&request)
        );
        
        // 2. Run models (parallel)
        let predictions = tokio::join!(
            self.xgboost_model.predict(&features),
            self.lstm_model.predict(&features),
            self.prophet_cache.get_forecast(&request.route, &request.date)
        );
        
        // 3. Ensemble voting
        let ensemble = self.ensemble_vote(predictions);
        
        // 4. Calibrate confidence
        let calibrated = self.calibrator.calibrate(ensemble);
        
        // 5. Build response
        PredictionResponse {
            recommendation: calibrated.class,
            confidence: calibrated.probability,
            predicted_low: self.compute_price_bounds(features).0,
            predicted_high: self.compute_price_bounds(features).1,
            factors: self.explain_prediction(features, predictions),
        }
    }
}</div>
            </div>

            <div class="subsection">
                <h4>ðŸ”§ Optimization Strategies</h4>
                <table>
                    <tr><th>Strategy</th><th>Implementation</th><th>Impact</th></tr>
                    <tr><td>Model quantization</td><td>INT8 quantization for XGBoost</td><td>2x speedup, minimal accuracy loss</td></tr>
                    <tr><td>Feature caching</td><td>Pre-compute route features in VayaCache</td><td>Eliminates DB queries</td></tr>
                    <tr><td>Prophet pre-computation</td><td>Generate forecasts for popular routes hourly</td><td>Removes Prophet from hot path</td></tr>
                    <tr><td>Batch inference</td><td>Process search results in batch (up to 50)</td><td>Amortize model loading</td></tr>
                    <tr><td>Connection pooling</td><td>Keep model instances warm</td><td>Eliminate cold starts</td></tr>
                    <tr><td>SIMD vectorization</td><td>Rust SIMD for feature normalization</td><td>10x faster preprocessing</td></tr>
                </table>
            </div>
        </section>

        <!-- ================================================================ -->
        <!-- ML-06: MONITORING & DRIFT DETECTION -->
        <!-- ================================================================ -->
        <section class="section">
            <div class="section-header">
                <span class="section-id">ML-06</span>
                <span class="section-title">Model Monitoring & Drift Detection</span>
            </div>

            <div class="subsection">
                <h4>ðŸ“ˆ Performance Metrics</h4>
                <table>
                    <tr><th>Metric</th><th>Target</th><th>Alert Threshold</th><th>Critical</th></tr>
                    <tr><td>Overall accuracy</td><td>&gt; 75%</td><td>&lt; 72%</td><td>&lt; 68%</td></tr>
                    <tr><td>Precision (buy_now)</td><td>&gt; 80%</td><td>&lt; 75%</td><td>&lt; 70%</td></tr>
                    <tr><td>Recall (buy_now)</td><td>&gt; 75%</td><td>&lt; 70%</td><td>&lt; 65%</td></tr>
                    <tr><td>Precision (wait)</td><td>&gt; 70%</td><td>&lt; 65%</td><td>&lt; 60%</td></tr>
                    <tr><td>Calibration error (ECE)</td><td>&lt; 0.05</td><td>&gt; 0.08</td><td>&gt; 0.12</td></tr>
                    <tr><td>Avg user savings</td><td>&gt; RM 50</td><td>&lt; RM 30</td><td>&lt; RM 15</td></tr>
                    <tr><td>Inference p95 latency</td><td>&lt; 100ms</td><td>&gt; 150ms</td><td>&gt; 300ms</td></tr>
                </table>
            </div>

            <div class="subsection">
                <h4>ðŸ” Drift Detection</h4>
                <table>
                    <tr><th>Drift Type</th><th>Detection Method</th><th>Check Frequency</th></tr>
                    <tr><td>Feature drift</td><td>KL divergence on feature distributions</td><td>Hourly</td></tr>
                    <tr><td>Label drift</td><td>Chi-squared test on prediction distribution</td><td>Daily</td></tr>
                    <tr><td>Concept drift</td><td>Accuracy on rolling 7-day window</td><td>Daily</td></tr>
                    <tr><td>Data quality drift</td><td>Missing value %, outlier %</td><td>Hourly</td></tr>
                </table>

                <div class="code-block"># Drift Detection (Rust)
struct DriftDetector {
    baseline_distributions: HashMap<String, Distribution>,
    threshold_kl: f64,  // 0.1
    threshold_psi: f64, // 0.2
}

impl DriftDetector {
    fn check_feature_drift(&self, feature: &str, current: &[f64]) -> DriftResult {
        let baseline = self.baseline_distributions.get(feature)?;
        let current_dist = Distribution::from_samples(current);
        
        let kl_div = kl_divergence(baseline, &current_dist);
        let psi = population_stability_index(baseline, &current_dist);
        
        DriftResult {
            feature: feature.to_string(),
            kl_divergence: kl_div,
            psi: psi,
            is_drifted: kl_div > self.threshold_kl || psi > self.threshold_psi,
            severity: if psi > 0.25 { "high" } else { "medium" },
        }
    }
}</div>
            </div>

            <div class="subsection">
                <h4>ðŸš¨ Alert & Remediation</h4>
                <table>
                    <tr><th>Condition</th><th>Action</th><th>Escalation</th></tr>
                    <tr><td>Accuracy &lt; 72% for 6h</td><td>Alert on-call, investigate</td><td>L1</td></tr>
                    <tr><td>Accuracy &lt; 68% for 1h</td><td>Auto-rollback to previous model</td><td>L2</td></tr>
                    <tr><td>Feature drift detected</td><td>Trigger incremental retrain</td><td>L1</td></tr>
                    <tr><td>Latency p95 &gt; 300ms</td><td>Scale up inference pods</td><td>L2</td></tr>
                    <tr><td>Model serving errors &gt; 1%</td><td>Failover to fallback model</td><td>L2</td></tr>
                </table>
            </div>
        </section>

        <!-- Summary -->
        <div style="background: linear-gradient(135deg, var(--n100), var(--n200)); border: 2px solid var(--purple); border-radius: 20px; padding: 40px; margin-top: 48px; text-align: center;">
            <h2 style="font-family: var(--font-display); font-size: 28px; font-weight: 800; margin-bottom: 16px;">ðŸ”® ORACLE ML SPECIFICATION COMPLETE</h2>
            <p style="color: var(--n700); margin-bottom: 24px;">Domain 4 (ML Design) â€” ML-01 through ML-06 âœ“</p>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; max-width: 600px; margin: 0 auto;">
                <div style="background: var(--n100); border-radius: 12px; padding: 16px;">
                    <div style="font-family: var(--font-display); font-size: 28px; font-weight: 800; color: var(--mint);">47</div>
                    <div style="font-size: 10px; color: var(--n600);">Features</div>
                </div>
                <div style="background: var(--n100); border-radius: 12px; padding: 16px;">
                    <div style="font-family: var(--font-display); font-size: 28px; font-weight: 800; color: var(--cyan);">3</div>
                    <div style="font-size: 10px; color: var(--n600);">Ensemble Models</div>
                </div>
                <div style="background: var(--n100); border-radius: 12px; padding: 16px;">
                    <div style="font-family: var(--font-display); font-size: 28px; font-weight: 800; color: var(--purple);">&lt;50ms</div>
                    <div style="font-size: 10px; color: var(--n600);">p50 Latency</div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
